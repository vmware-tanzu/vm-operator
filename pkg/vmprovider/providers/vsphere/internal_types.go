// Copyright (c) 2020 VMware, Inc. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0

package vsphere

import (
	"context"

	"github.com/vmware/govmomi/object"
	"github.com/vmware/govmomi/vim25"
	"github.com/vmware/govmomi/vim25/soap"
	"github.com/vmware/govmomi/vim25/types"
)

type InvokeFSR_TaskRequest struct {
	This types.ManagedObjectReference `xml:"_this"`
}

type InvokeFSR_TaskResponse struct {
	Returnval types.ManagedObjectReference `xml:"returnval"`
}

type InvokeFSR_TaskBody struct {
	Req    *InvokeFSR_TaskRequest  `xml:"urn:vim25 InvokeFSR_Task,omitempty"`
	Res    *InvokeFSR_TaskResponse `xml:"InvokeFSR_TaskResponse,omitempty"`
	Fault_ *soap.Fault             `xml:"http://schemas.xmlsoap.org/soap/envelope/ Fault,omitempty"`
}

func (b *InvokeFSR_TaskBody) Fault() *soap.Fault {
	return b.Fault_
}

func InvokeFSR_Task(ctx context.Context, r soap.RoundTripper, req *InvokeFSR_TaskRequest) (*InvokeFSR_TaskResponse, error) {
	var reqBody, resBody InvokeFSR_TaskBody
	reqBody.Req = req
	if err := r.RoundTrip(ctx, &reqBody, &resBody); err != nil {
		return nil, err
	}
	return resBody.Res, nil
}

func VirtualMachineFSR(ctx context.Context, vm types.ManagedObjectReference, client *vim25.Client) (*object.Task, error) {
	req := InvokeFSR_TaskRequest{
		This: vm,
	}
	res, err := InvokeFSR_Task(ctx, client, &req)
	if err != nil {
		return nil, err
	}
	return object.NewTask(client, res.Returnval), nil
}
